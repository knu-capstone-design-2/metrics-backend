# Consumer 모듈

## 개요

이 모듈은 Kafka로부터 메시지를 수신하고 이를 처리하는 역할을 담당합니다. 주요 기능은 메트릭 기반의 메시지를 배치 단위로 수신하여 시스템 내 데이터 저장소에 반영하고, 실시간 알림이 필요한 경우 **웹소켓을 통해 클라이언트(웹 프론트엔드)로 데이터를 전송**하는 것입니다. 병렬 처리 기반의 구조로 대량 데이터에 효과적으로 대응할 수 있습니다.

---

## 환경 변수 설정

`env.properties` 파일 또는 시스템 환경 변수에 다음과 같은 항목들을 정의해야 합니다.

### 필수 환경 변수

| 변수명                            | 설명                                               |
|--------------------------------|--------------------------------------------------|
| `BOOTSTRAP_SERVER`             | Kafka 브로커 주소 (예: `localhost:9094`, `kafka:9094`) |
| `GROUP_ID`                     | Kafka Consumer 그룹 ID                             |
| `KAFKA_TOPIC_HOST`             | 메트릭 메시지를 수신할 host 메세지를 담은 Kafka 토픽 이름            |
| `KAFKA_TOPIC_CONTAINER`        | 메트릭 메시지를 수신할 container 메세지를 담은 Kafka 토픽 이름       |
| `KAFKA_GROUP_ID_STORAGE_GROUP` | (선택) 데이터 저장소용 그룹 ID                              |

> ⚠️ 모든 Kafka 토픽이 사전에 생성되어 있어야 하며, 그룹 ID 충돌이 없도록 관리해야 합니다.

---

## 애플리케이션 설정

`application.properties` 파일을 통해 애플리케이션이 구동되며, 주요 설정 값은 환경 변수로부터 주입됩니다.

> ⚠️ 해당 파일의 kafka 설정 값은 default값이며 별다른 이슈가 없을 경우, configuration으로 따로 설정된 값을 사용합니다. 따라서 kafka 설정 관련 값은 설정하지 않아도 무방합니다.

### 일반 정보

- **애플리케이션 이름**: `consumer`
- **서버 포트**: `8000`s

### Kafka 설정

- **Kafka 서버 주소**: `${BOOTSTRAP_SERVER}`
- **Consumer 그룹 ID**: `${GROUP_ID}`
- **오프셋 전략**: `earliest`
- **자동 커밋**: 비활성화
- **최대 폴링 수**: 200건
- **병렬 처리 수**: 2개 스레드
- **Ack 방식**: 수동 모드 (`manual`)

---

## Kafka 메시지 처리

해당 모듈은 JSON 형식의 메트릭 데이터를 Kafka로부터 배치 단위로 수신하여 처리합니다. 수신된 메시지는 트랜잭션 내에서 처리됩니다.

---

## 웹소켓 통신

### 목적

- Kafka로부터 수신된 데이터를 **웹 프론트엔드 또는 기타 클라이언트**에 실시간으로 전송하여 UI 반영 속도를 높이고 사용자 경험을 개선합니다.

### 구조

1. Kafka에서 메시지를 수신
2. 내부 처리 후 필요 시 특정 조건에 따라 웹소켓 이벤트 발행
3. 클라이언트는 지정된 웹소켓 endpoint에 연결되어 있으며, 해당 데이터를 실시간으로 수신

### 엔드포인트 예시

```http
ws://{HOST}:{PORT}/ws/metrics
```

## 로깅 설정

개발 및 디버깅을 위한 다양한 로그 레벨이 설정되어 있으며, 주요 로그 항목은 다음과 같습니다:

- SQL 쿼리 및 파라미터 바인딩
- Kafka 클라이언트 동작 로그
- 웹 요청 관련 로그

> 운영 환경에서는 로그 레벨을 적절히 조정할 것을 권장합니다.

---

## 참고 사항

- Kafka 브로커와의 연결이 정상적으로 가능해야 하며, 필요한 모든 설정이 사전에 준비되어야 합니다.
- 운영 환경에서는 적절한 커넥션 풀 및 장애 대응 전략 설정이 필요합니다.

---

## 문의

기술적인 문의는 백엔드 개발팀에 문의해 주세요.
